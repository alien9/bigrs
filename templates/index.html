<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="/css/ol.css" type="text/css">
    <script src="/js/jquery-3.1.1.min.js"></script>
    <script src="/js/ol-debug.js"></script>
    <script src="/js/Chart.bundle.min.js"></script>
    <style type="text/css">

      .selected{
        background-color:#00b;
        color:white;
      }
      #search_results{
        font-family:sans-serif;
      }
      #search_results a{
        display:block;
      }
      .ol-popup {
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "✖";
      }
    </style>
    <title>BIGRS</title>
  </head>
  <body style="position:relative">
  <input type="hidden" name="codlog">
  <div id="mapa" class="mapa" style="height:600px;background:#ccc;">
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>
  </div>
  <div id="popup_template" style="display:none">
      <p class="titulo">$name</p>
      <p><a href="javascript:void(0);" class="marker_remove">remover</a></p>
  </div>
  <div style="position:absolute;top:5px;right:5px;width:200px"><input type="text" name="search">
      <div style="background-color:#eee;overflow:hidden;width:100%" id="search_results"></div>
  </div>
  </body>
    <script type="text/javascript">
    var hash=[];
    var diacriticsMap = {
  '\u00C0': 'A',  // À => A
  '\u00C1': 'A',   // Á => A
  '\u00C2': 'A',   // Â => A
  '\u00C3': 'A',   // Ã => A
  '\u00C4': 'A',   // Ä => A
  '\u00C5': 'A',   // Å => A
  '\u00C6': 'AE', // Æ => AE
  '\u00C7': 'C',   // Ç => C
  '\u00C8': 'E',   // È => E
  '\u00C9': 'E',   // É => E
  '\u00CA': 'E',   // Ê => E
  '\u00CB': 'E',   // Ë => E
  '\u00CC': 'I',   // Ì => I
  '\u00CD': 'I',   // Í => I
  '\u00CE': 'I',   // Î => I
  '\u00CF': 'I',   // Ï => I
  '\u0132': 'IJ', // Ĳ => IJ
  '\u00D0': 'D',   // Ð => D
  '\u00D1': 'N',   // Ñ => N
  '\u00D2': 'O',   // Ò => O
  '\u00D3': 'O',   // Ó => O
  '\u00D4': 'O',   // Ô => O
  '\u00D5': 'O',   // Õ => O
  '\u00D6': 'O',   // Ö => O
  '\u00D8': 'O',   // Ø => O
  '\u0152': 'OE', // Œ => OE
  '\u00DE': 'TH', // Þ => TH
  '\u00D9': 'U',   // Ù => U
  '\u00DA': 'U',   // Ú => U
  '\u00DB': 'U',   // Û => U
  '\u00DC': 'U',   // Ü => U
  '\u00DD': 'Y',   // Ý => Y
  '\u0178': 'Y',   // Ÿ => Y
  '\u00E0': 'a',   // à => a
  '\u00E1': 'a',   // á => a
  '\u00E2': 'a',   // â => a
  '\u00E3': 'a',   // ã => a
  '\u00E4': 'a',   // ä => a
  '\u00E5': 'a',   // å => a
  '\u00E6': 'ae', // æ => ae
  '\u00E7': 'c',   // ç => c
  '\u00E8': 'e',   // è => e
  '\u00E9': 'e',   // é => e
  '\u00EA': 'e',   // ê => e
  '\u00EB': 'e',   // ë => e
  '\u00EC': 'i',   // ì => i
  '\u00ED': 'i',   // í => i
  '\u00EE': 'i',   // î => i
  '\u00EF': 'i',   // ï => i
  '\u0133': 'ij', // ĳ => ij
  '\u00F0': 'd',   // ð => d
  '\u00F1': 'n',   // ñ => n
  '\u00F2': 'o',   // ò => o
  '\u00F3': 'o',   // ó => o
  '\u00F4': 'o',   // ô => o
  '\u00F5': 'o',   // õ => o
  '\u00F6': 'o',   // ö => o
  '\u00F8': 'o',   // ø => o
  '\u0153': 'oe', // œ => oe
  '\u00DF': 'ss', // ß => ss
  '\u00FE': 'th', // þ => th
  '\u00F9': 'u',   // ù => u
  '\u00FA': 'u',   // ú => u
  '\u00FB': 'u',   // û => u
  '\u00FC': 'u',   // ü => u
  '\u00FD': 'y',   // ý => y
  '\u00FF': 'y',   // ÿ => y
  '\uFB00': 'ff', // ﬀ => ff
  '\uFB01': 'fi',   // ﬁ => fi
  '\uFB02': 'fl', // ﬂ => fl
  '\uFB03': 'ffi',  // ﬃ => ffi
  '\uFB04': 'ffl',  // ﬄ => ffl
  '\uFB05': 'ft', // ﬅ => ft
  '\uFB06': 'st'  // ﬆ => st
};
function replaceDiacritics(str) {
  var returnStr = '';
  if(str) {
    for (var i = 0; i < str.length; i++) {
      if (diacriticsMap[str[i]]) {
        returnStr += diacriticsMap[str[i]];
      } else {
        returnStr += str[i];
      }
    }
  }
  return returnStr;
}
function select(i){
    var j=0;
    $('#search_results').children('a').each(function () {
        if(j==i){
            $(this).addClass('selected');
        }else{
            $(this).removeClass('selected');
        }
        j++;
    });
}
/**
 * Elements that make up the popup.
 */
var container = document.getElementById('popup');
var content = document.getElementById('popup-content');
var closer = document.getElementById('popup-closer');

var selected_marker;


var zoom;
var center;
var vectorSource;
      var tiled = new ol.layer.Tile({
        visible: true,
        source: new ol.source.TileWMS({
          url: 'http://192.168.167.8:8080/geoserver/BIGRS/wms',
          params: {'FORMAT': 'image/png',
                   'VERSION': '1.1.1',
                   tiled: true,
                STYLES: '',
                LAYERS: 'BIGRS:sirgas_shp_logradouro',
             tilesOrigin: -46.83525376879412 + "," + -24.012624936562503
          }
        })
      });
      var untiled = new ol.layer.Image({
        source: new ol.source.ImageWMS({
          ratio: 1,
          url: 'http://192.168.167.8:8080/geoserver/BIGRS/wms',
          params: {'FORMAT': 'image/png',
                   'VERSION': '1.1.1',
                STYLES: '',
                LAYERS: 'BIGRS:Incidentes',
          }
        })
      });
      var projection = new ol.proj.Projection({
          code: 'EPSG:4326',
          units: 'degrees',
          axisOrientation: 'neu'
      });
      var map;
      var selected=0;
      $(document).ready(function(){

        var iconFeature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.transform([-46.5, -23.5], projection, 'EPSG:3857')),
            name: 'Null Island',
            population: 4000,
            rainfall: 500
        });

        var iconStyle = new ol.style.Style({
            image: new ol.style.Icon({
              anchor: [0.5, 32],
              anchorXUnits: 'fraction',
              anchorYUnits: 'pixels',
              src: '/icons/blue.png'
            })
        });
        iconFeature.setStyle(iconStyle);
        vectorSource = new ol.source.Vector({
          features: []
        });
        var vectorLayer = new ol.layer.Vector({
            source : vectorSource
        });

        zoom=12;
        var c=document.cookie.match(/zoom=(\d+)/);
        if(c) zoom=parseFloat(c.pop());
        center=ol.proj.fromLonLat([-46.5, -23.5]);
        c=document.cookie.match(/center=([^;]+);/);
        if(c) {
            c=c.pop().split(/,/);
            center=[parseFloat(c[0]),parseFloat(c[1])];
        }
        popup = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
          element: container,
          autoPan: true,
          autoPanAnimation: {
            duration: 250
          }
        }));
        closer.onclick = function() {
          popup.setPosition(undefined);
          closer.blur();
          return false;
        };
        map = new ol.Map({
            target: 'mapa',
            layers: [
              tiled
            ],
            overlays:[popup],
            view: new ol.View({
              'center': center,
              'zoom': zoom
            })
        });

        map.on("moveend",function(){
            document.cookie="center="+map.getView().getCenter();
            document.cookie="zoom="+map.getView().getZoom();
        });

        map.on("zoomend",function(){
            document.cookie="center="+map.getView().getCenter();
            document.cookie="zoom="+map.getView().getZoom();
        });

        map.on("click", function(e){
            var isFeature=false;
            var coordinate=e.coordinate;
            console.debug(coordinate);
            var f;
            map.forEachFeatureAtPixel(e.pixel, function (feature, layer) {
                f=feature;
                isFeature=true;
            })
            if(isFeature){
                var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326'));
                var html=$('#popup_template').html();
                html=html.replace(/\$name/,f.getProperties().name);
                content.innerHTML = html;
                popup.setPosition(coordinate);
                selected_marker=f;
                $(content).find('a.marker_remove').click(function(){
                    if(selected_marker)vectorSource.removeFeature(selected_marker);
                    selected_marker=null;
                    popup.setPosition(undefined);
                    closer.blur();
                });
                $.ajax('/report',{data:{codlog:f.getProperties().codlog},dataType:'json',success:function(r){
                    console.debug(r)
                }});
                return;
            }
            var lonlat = ol.proj.toLonLat(map.getCoordinateFromPixel(e.pixel));
            $.ajax('/reverse',{'method':'post',dataType:'json', data:{point:lonlat}, success:function(j){
                console.debug(j);
                var featurething = new ol.Feature({
                    name: j.endereco,
                    number: j.numero,
                    codlog: j.codlog,
                    geometry: new ol.geom.Point(ol.proj.transform([j.x,j.y], 'EPSG:4326', 'EPSG:3857'))
                });
                featurething.setStyle(iconStyle);
                vectorSource.addFeature( featurething );
            }});
        });

        with(map.getView()){
            setZoom(zoom);
            setCenter(center);
        }
        map.addLayer(untiled);
        map.addLayer(vectorLayer);

        function geocode(){
            var codlog=$("input[name=codlog]").val();
            var a=$("input[name=search]").val().match(/\d+$/);
            var numero='0';
            if(a) numero=a.pop();
            $.ajax('/geocode', {method:'post',dataType:'json',data:{'numero':numero,'codlog':codlog}, success:function(j){
                map.getView().setCenter(ol.proj.fromLonLat([j['x'], j['y']]));
            }});
        }
        var term="";
        var load=function(j){
            $("#search_results").html('');
            hash=j;
            var n=0;
            for(var i=0;i<j.length;i++){
                var a=$.extend([],j[i]);
                var id=a.shift();
                var t=a.join(" ").replace(/\s+/,' ');
                if(t.match(new RegExp(replaceDiacritics(term).toUpperCase()))){
                    $("#search_results").append('<a href="javascript:void(0);" codlog="'+id+'">'+t+"</a>");
                    n++;
                    if(n>=20) break;
                }
            }
            select(selected);
            $('#search_results a').click(function(){
                selected=0;
                var a=$(this);
                $("input[name=search]").val(a.text()+" ");
                $("input[name=codlog]").val(a.attr('codlog'));
                $('#search_results').html('');
                $('input[name=search]').focus();
            });
        };
        $("input[name=search]").keyup(function(e){
            var text=$("input[name=search]").val();
            if(text.length==0) $("#search_results").html('');
            if(term.substr(0,2)==text.substring(0,2)){
                term=text;
                load(hash);
            }else{
                term=text;
                if(term.length<2)return;
                $.ajax('/search',{data:{'term':term},dataType:'json',method:'post',success:load});
            }
            switch(e.which){
                case 38:
                    selected--;
                    if(selected<0) selected=$('#search_results').children('a').length-1;
                    select(selected);
                break;
                case 40:
                    selected++;
                    if(selected>$('#search_results').children('a').length-1) selected=0;
                    select(selected);
                break;
                case 13:
                    var ab=$('#search_results').children('a');
                    if(ab.length>0){
                        var a=$(ab[selected]);
                        $("input[name=search]").val(a.text()+" ");
                        $("input[name=codlog]").val(a.attr('codlog'));
                        $('#search_results').html('');
                    }else{
                        geocode();
                    }
                    break;
            }
        });
      });
    </script>
</html>